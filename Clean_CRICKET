USE role sysadmin;
use warehouse compute_wh;
use schema cricket.clean;

grant ownership to sysadmin on Cricket.Clean;

select distinct match_type_number from delivery_clean_tbl;

desc table cricket.clean.delivery_clean_tbl;

--add not null and fk relationships
alter table cricket.clean.delivery_clean_tbl
modify column match_type_number set not null;
    
alter table cricket.clean.delivery_clean_tbl
modify column team_name set not null;
    
alter table cricket.clean.delivery_clean_tbl
modify column ove set not null


    
alter table cricket.clean.delivery_clean_tbl
modify column bowler set not null;
    
alter table cricket.clean.delivery_clean_tbl
modify column batter set not null;
    
alter table cricket.clean.delivery_clean_tbl
modify column non_striker set not null;
    
-- fk relations
alter table cricket.clean.delivery_clean_tbl
add constraint fk_delivery_match_id
foreign key (match_type_number)
references cricket.clean.match_detail_clean(match_type_number)

select get_ddl('table','delivery_clean_tbl')
-- first step
select 
    meta['data_version']::text as data_version,
    meta['created']::date as created,
    meta['revision']::number as revision
from 
    cricket.raw.match_raw_tbl;



select * from cricket.clean.player_clean_tbl;

-- lets desc table:

desc table cricket.clean.player_clean_tbl;


-- add not null and fk relationships
alter table cricket.clean.player_clean_tbl
modify column match_type_number set not null;

alter table cricket.clean.player_clean_tbl
modify column country set not null;

alter table cricket.clean.player_clean_tbl
modify column player_name set not null;

alter table cricket.clean.match_detail_clean
add constraint pk_match_type_number primary key (match_type_number)

-- fk relation
alter table cricket.clean.player_clean_tbl
add constraint fk_match_id
foreign key (match_type_number)
references cricket.clean.match_detail_clean(match_type_number)

select get_ddl('table','cricket.clean.player_clean_tbl')

-- Step-2 extract elements from into column that is of varient data type


select 
    info:match_type_number::int as match_type_number,
    info:match_type::text as match_type,
    info:season::text as season,
    info:team_type::text as team_type,
    info:overs::text as overs,
    info:city::text as city,
    info:venue::text as venue

from cricket.raw.match_raw_tbl;


-- EXTRACT CLEAN MATCH DATA(parent_table)

create or replace transient table cricket.clean.match_detail_clean as
select 
    info:match_type_number::int as match_type_number,
    info:event.name::text as event_name,
    case 
        when info:event.match_number::text is not null then info:event.match_number::text
        else 'NA'
    end as match_stage,
    info:dates[0]::date as event_date,
    date_part('year',info:dates[0]::date) as event_year,
    date_part('month',info:dates[0]::date) as event_month,
    date_part('day',info:dates[0]::date) as event_day,
    info:match_type::text as match_type,
    info:season::text as season,
    info:team_type::text as team_type,
    info:overs::text as overs,
    info:city::text as city,
    info:venue::text as venue,
    info:gender::text as gender,
    info:teams[0]::text as first_team,
    info:teams[1]::text as second_team,
    case
        when info:outcome.winner is not null then 'Result Declared'
        when info:outcome.result = 'tie' then 'Tie'
        when info:outcome.result = 'no result' then 'No Result' -- Fixed Syntax
        else 'Other'
    end as match_result,
    case 
        when info:outcome.winner is not null then info:outcome.winner
        else 'NA'
    end as winner,

    info:toss.winner::text as toss_winner,
    initcap(info:toss.decision::text) as toss_decision,

    stg_file_name,
    stg_file_row_number,
    stg_file_hashkey,
    stg_modified_ts
from
    cricket.raw.match_raw_tbl; 


-- 1) First cleaning (Extract clean MATCH data and PLAYER data)
-- Extract players
-- 1) 
    select 
        raw.info:match_type_number::int as match_type_number,
        raw.info:players as player,
        raw.info:teams as teams
    from cricket.raw.match_raw_tbl raw;

-- 2) 
    select 
        raw.info:match_type_number::int as match_type_number,
        raw.info:players,
        raw.info:teams
    from cricket.raw.match_raw_tbl raw
    where match_type_number = 4673;


-- 3) 
    select 
        raw.info:match_type_number::int as match_type_number,
        p.*
        -- p.key::text as country
        from cricket.raw.match_raw_tbl raw,
        lateral flatten (input => raw.info:players) p
        where match_type_number = 3864


-- version 4

select 
    raw.info:match_type_number::int as match_type_number,
    p.key::text as country,
    -- team.*
    team.value::text as player_name
from cricket.raw.match_raw_tbl raw,
lateral flatten (input => raw.info:players) p,
lateral flatten (input => p.value) team
where match_type_number = 4676;

-- version 5 -- create table for player(child table)
create or replace table  cricket.clean.player_clean_tbl as
select
    raw.info:match_type_number::int as match_type_number,
    p.key::text as country,
    team.value::text as player_name,
    raw.stg_file_name,
    raw.stg_file_row_number,
    raw.stg_file_hashkey,
    raw.stg_modified_ts
from cricket.raw.match_raw_tbl raw,
lateral flatten(input => raw.info:players) p,
lateral flatten(input => p.value)team;

-- SECOND CLEANING
-- version 1 : lets extract the elments from the innings array
-- Extract clean bowling data
select 
    m.info:match_type_number::int as match_type_number,
    m.innings
from cricket.raw.match_raw_tbl m
where match_type_number = 3836;

-- v2
select 
    m.info:match_type_number::int as match_type_number,
    i.*
from cricket.raw.match_raw_tbl m,
lateral flatten (input => m.innings) i
where match_type_number = 4696;

--v3
select 
    m.info:match_type_number::int as match_type_number,
    i.value:team::text as team_name,
    o.value:team::int as over,
    d.value:bowler::text as bowler,
    d.value:batter::text as batter,
    d.value:non_striker::text as non_striker,
    d.value:runs.batter::text as runs,
    d.value:runs.extras::text as extras,
    d.value:runs.total::text as total,
   
from cricket.raw.match_raw_tbl m,
lateral flatten (input => m.innings) i,
lateral flatten (input => i.value:overs) o,
lateral flatten (input => o.value:deliveries) d,
where match_type_number = 4696;


-- v4
select 
    m.info:match_type_number::int as match_type_number,
    i.value:team::text as team_name,
    o.value:team::int as over,
    d.value:bowler::text as bowler,
    d.value:batter::text as batter,
    d.value:non_striker::text as non_striker,
    d.value:runs.batter::text as runs,
    d.value:runs.extras::text as extras,
    d.value:runs.total::text as total,
    -- e.*
    e.key::text as extra_type,
    e.value::number as extra_runs,
    
    
from cricket.raw.match_raw_tbl m,
lateral flatten (input => m.innings) i,
lateral flatten (input => i.value:overs) o,
lateral flatten (input => o.value:deliveries) d,
lateral flatten (input => d.value:extras , outer => TRUE) e,
lateral flatten (input => d.value:wickets, outer => TRUE) w,
where match_type_number = 4696;

-- v3
select 
    m.info:match_type_number::int as match_type_number,
    i.value:team::text as team_name,
    o.value:team::int as over,
    d.value:bowler::text as bowler,
    d.value:batter::text as batter,
    d.value:non_striker::text as non_striker,
    d.value:runs.batter::text as runs,
    d.value:runs.extras::text as extras,
    d.value:runs.total::text as total,
    -- e.*
    e.key::text as extra_type,
    e.value::number as extra_runs,
 
from cricket.raw.match_raw_tbl m,
lateral flatten (input => m.innings) i,
lateral flatten (input => i.value:overs) o,
lateral flatten (input => o.value:deliveries) d,
lateral flatten (input => d.value:extras , outer => TRUE) e,
where match_type_number = 4696;

-- v5
select 
    m.info:match_type_number::int as match_type_number,
    i.value:team::text as team_name,
    o.value:team::int as over,
    d.value:bowler::text as bowler,
    d.value:batter::text as batter,
    d.value:non_striker::text as non_striker,
    d.value:runs.batter::text as runs,
    d.value:runs.extras::text as extras,
    d.value:runs.total::text as total,
    -- e.*
    e.key::text as extra_type,
    e.value::number as extra_runs,
    -- w.*
    w.value:player_out::text as player_out,
    w.value:kind::text as player_out_kind,
    w.value:fielders::variant as player_out_filders
    
from cricket.raw.match_raw_tbl m,
lateral flatten (input => m.innings) i,
lateral flatten (input => i.value:overs) o,
lateral flatten (input => o.value:deliveries) d,
lateral flatten (input => d.value:extras , outer => TRUE) e,
lateral flatten (input => d.value:wickets, outer => TRUE) w,
where match_type_number = 4696;

-- v6
create or replace transient table cricket.clean.delivery_clean_tbl as
select 
    m.info:match_type_number::int as match_type_number,
    i.value:team::text as team_name,
    o.value:team::int as over,
    d.value:bowler::text as bowler,
    d.value:batter::text as batter,
    d.value:non_striker::text as non_striker,
    d.value:runs.batter::text as runs,
    d.value:runs.extras::text as extras,
    d.value:runs.total::text as total,
    -- e.*
    e.key::text as extra_type,
    e.value::number as extra_runs,
    -- w.*
    w.value:player_out::text as player_out,
    w.value:kind::text as player_out_kind,
    w.value:fielders::variant as player_out_filders,
    m.stg_file_name,
    m.stg_file_row_number,
    m.stg_file_hashkey,
    m.stg_modified_ts
    
from cricket.raw.match_raw_tbl m,
lateral flatten (input => m.innings) i,
lateral flatten (input => i.value:overs) o,
lateral flatten (input => o.value:deliveries) d,
lateral flatten (input => d.value:extras , outer => TRUE) e,
lateral flatten (input => d.value:wickets, outer => TRUE) w;




